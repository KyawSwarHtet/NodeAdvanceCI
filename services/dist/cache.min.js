"use strict";var mongoose=require("mongoose"),redis=require("redis"),util=require("util"),redisUrl="redis://127.0.0.1:6379",client=redis.createClient(redisUrl);client.hget=util.promisify(client.hget);var exec=mongoose.Query.prototype.exec;mongoose.Query.prototype.cache=function(){var e=0<arguments.length&&void 0!==arguments[0]?arguments[0]:{};return this.useCache=!0,this.hashKey=JSON.stringify(e.key||""),this},mongoose.Query.prototype.exec=function(){var t,r,n,i,s=this,o=arguments;return regeneratorRuntime.async(function(e){for(;;)switch(e.prev=e.next){case 0:if(this.useCache){e.next=2;break}return e.abrupt("return",exec.apply(this,o));case 2:return t=JSON.stringify(Object.assign({},this.getQuery(),{collection:this.mongooseCollection.name})),e.next=5,regeneratorRuntime.awrap(client.hget(this.hashKey,t));case 5:if(r=e.sent)return console.log("fetching cached value"),n=JSON.parse(r),e.abrupt("return",Array.isArray(n)?n.map(function(e){return new s.model(e)}):new this.model(n));e.next=10;break;case 10:return e.next=12,regeneratorRuntime.awrap(exec.apply(this,o));case 12:return i=e.sent,client.hset(this.hashKey,t,JSON.stringify(i)),e.abrupt("return",i);case 15:case"end":return e.stop()}},null,this)},module.exports={clearHash:function(e){client.del(JSON.stringify(e))}};
//# sourceMappingURL=cache.min.js.map
